Menu="VMs:2"
Title="Hotplug USB"
Cond="$var['fsState'] == 'Started'"
---
<?php
/* Copyright 2016, Burhan Shakil
 * Copyright 2018-2026, Dan Landon
 * Copyright 2026, Naphtaline
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License version 3,
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 */
?>

<link rel="stylesheet" href="<?autov("/plugins/libvirt.hotplug.usb/assets/libvirthotplug.css")?>">

<?
/* Define our plugin name. */
define('LIBVIRT_HOTPLUG_PLUGIN', 'libvirt.hotplug.usb');

/* Define the docroot path. */
if (!defined('DOCROOT')) {
	define('DOCROOT', $_SERVER['DOCUMENT_ROOT'] ?: '/usr/local/emhttp');
}
?>

<?if ($var['fsState'] == 'Started'):?>
<?

require_once(DOCROOT.'/webGui/include/Helpers.php');
require_once(DOCROOT.'/plugins/dynamix.vm.manager/include/libvirt.php');
require_once(DOCROOT.'/plugins/dynamix.vm.manager/include/libvirt_helpers.php');

/* This function replaces getValidUSBDevices() from archived repo dynamix.vm.manager. */
function get_complete_usb_devices_infos(): array
{
	$devices	= [];
	$lines		= [];

	exec('lsusb 2>/dev/null', $lines);

	$flashGuid = (string)($GLOBALS['var']['flashGUID'] ?? '');

	/* First pass: parse and filter. */
	$parsed = [];
	foreach ($lines as $line) {
		if (!preg_match(
			'/Bus (?P<bus>\d{3}) Device (?P<device>\d{3}): ID (?P<vid>[0-9a-fA-F]{4}):(?P<pid>[0-9a-fA-F]{4}) (?P<name>.*)$/',
			$line,
			$m
		)) {
			continue;
		}

		$bus	= (int)$m['bus'];
		$dev	= (int)$m['device'];
		$vid	= strtolower($m['vid']);
		$pid	= strtolower($m['pid']);
		$name	= trim((string)$m['name']);

		/* Skip Unraid boot device. */
		if ($flashGuid !== '' && stripos($flashGuid, $vid . '-' . $pid) === 0) {
			continue;
		}

		/* Skip Linux root hubs. */
		if ($vid === '1d6b' && in_array($pid, ['0001', '0002', '0003'], true)) {
			continue;
		}

		$parsed[] = [
			'bus'	=> $bus,
			'device'=> $dev,
			'id_1'	=> $vid,
			'id_2'	=> $pid,
			'id'	=> $vid . ':' . $pid,
			'name'	=> $name,
		];
	}

	/* Count duplicates by "same name" (case-insensitive, trimmed). */
	$nameCounts = [];
	foreach ($parsed as $d) {
		$key = strtolower(trim($d['name']));
		if ($key === '') {
			/* Treat unnamed devices as unique per Bus/Device to avoid collapsing. */
			$key = '__unnamed__|'.$d['id'].'|'.$d['bus'].'|'.$d['device'];
		}
		$nameCounts[$key] = ($nameCounts[$key] ?? 0) + 1;
	}

	/* Emit:
	 * - If the same name shows up more than once: show all and append Bus/Device.
	 * - Otherwise: show only one entry for that name (suppress duplicates) and omit Bus/Device.
	 */
	$emittedSingleName = [];

	foreach ($parsed as $d) {
		$nameKey = strtolower(trim($d['name']));
		$isUnnamed = false;

		if ($nameKey === '') {
			$isUnnamed = true;
			$nameKey = '__unnamed__|'.$d['id'].'|'.$d['bus'].'|'.$d['device'];
		}

		$isDupName = (($nameCounts[$nameKey] ?? 0) > 1);

		if (!$isDupName && !$isUnnamed) {
			if (isset($emittedSingleName[$nameKey])) {
				continue;
			}
			$emittedSingleName[$nameKey] = true;
		}

		$baseName = ($d['name'] === '') ? sprintf('[unnamed device] %s', $d['id']) : $d['name'];

		$displayName = $isDupName ? sprintf('%s | Bus:%d Device:%d', $baseName, $d['bus'], $d['device']) : $baseName;

		$devices[] = [
			'bus'	=> $d['bus'],
			'device'=> $d['device'],
			'id_1'	=> $d['id_1'],
			'id_2'	=> $d['id_2'],
			'id'	=> $d['id'],
			'name'	=> $displayName,
		];
	}

	return $devices;
}

/* Get array of usb devices. */
$arrValidUSBDevices = get_complete_usb_devices_infos();

/* Get domain variables for each domain. */
$doms = $lv->get_domains();
$vmlist=array();

for ($i = 0; $i < sizeof($doms); $i++)
{
	global $vmlist;

	$name	= $doms[$i];
	$res	= $lv->get_domain_by_name($name);
	$dom	= $lv->domain_get_info($res);
	$state	= $lv->domain_state_translate($dom['state']);

	if ($state == 'running')
	{
		global $vmlist;
		$vmlist[]=array('name'=>$name);
		asort($vmlist);
	}
}


function list_usbs()
{
	global $arrValidUSBDevices;
	$out = array();
	if (!empty($arrValidUSBDevices))
	{
		foreach($arrValidUSBDevices as $i => $arrDev)
		{
			$out[] = array('name'=>$arrDev['name'],'id'=>$arrDev['id'], 'bus'=>$arrDev['bus'], 'device'=>$arrDev['device']);
		}
	} else {
		$out[] = array('name'=>"None available");
	}

	asort($out);

	return $out;
}
?>

<form markdown="1" method="POST" action="/update.php" target="progressFrame">
<span class="inline-block">
<strong><?=_('Running VMs')?>:</strong>
	<select name="vms" size="1" class="lh-vm-select">
		<?foreach ($vmlist as $vms):?>
			<?=mk_option("",$vms['name'],$vms['name'])?>
		<?endforeach;?>
	</select>
</span>
&nbsp;
<span class="inline-block">
<strong><?=_('USB Devices')?>:</strong>
	<select name="usbs" size="1" class="lh-device-select" id="selectedUSBDevice">
		<?foreach (list_usbs() as $usb):?>
			<?=mk_option("",$usb['id'],$usb['name'], "data-bus=" . $usb['bus'] . " " . "data-device=" . $usb['device'])?>
		<?endforeach;?>
	</select>
</span>

:libvirt_hot_plug:
> Select the VM for the USB device to be attached/detached and the USB device for the selected VM.
:end

<input type="button" value="<?=_('Attach')?>" class="tooltip" title="<?=_('Attach the USB device to the selected VM')?>" onclick="operateUSB('attach');" id="attach" style="margin-top:0">
<input type="button" value="<?=_('Detach')?>" class="tooltip" title="<?=_('Detach the USB device from the selected VM')?>" onclick="operateUSB('detach');" id="detach" style="margin-top:0">

<strong><?=_('Result');?>:</strong>

<textarea class="lh-result-textbox" readonly name="Status" rows="7" cols="80"></textarea>

<strong><?=_('Note');?>:</strong>
<p><?=_('Some USB Devices require detaching and attaching multiple times to be properly detected by VMs')?>.</p>
<p><?=_('If you disconnected the USB device while it was attached to a VM, you will have to detach it and then re-attach it')?>.</p>

<input type="button" value="<?=_('Refresh')?>" onclick="refresh()">
</form>
<?endif;?>

<script>
const LVURL = '/plugins/<?=LIBVIRT_HOTPLUG_PLUGIN?>/include/virshcmd.php';

function operateUSB(action)
{
	let vmSelected = $("select[name=vms] option:selected");
	let usbSelected = $("select[name=usbs] option:selected");

	let vm = vmSelected.val();
	let usbid = usbSelected.val();

	let bus = usbSelected.attr('data-bus');
	let device = usbSelected.attr('data-device');

	if (vm && usbid) {
		switch (action) {
			case 'detach':
				status = "<?=_('Detaching Please wait')?>"+"...";
				break;

			case 'attach':
				status = "<?=_('Attaching Please wait')?>"+"...";
				break;
		}
		$("textarea[name=Status]").val(status);
		$("#detach").attr("disabled", true);
		$("#attach").attr("disabled", true);
		let opts = new Object();
		opts["action"] = action;
		opts["VMNAME"] = vm;
		opts["USBID"] = usbid;
		opts["USBBUS"] = bus;
		opts["USBDEVICE"] = device;
		$.post(LVURL,opts).done(function(data){
			if (data) {
				$("textarea[name=Status]").val(data.substr(1));
			}
			$("#detach").attr("disabled", false);
			$("#attach").attr("disabled", false);
		});
	} else {
		if (! vm) {
			$("textarea[name=Status]").val("<?=_('No VM Selected')?>!");
		} else {
			$("textarea[name=Status]").val("<?=_('No USB devices')?>!");
		}
	}
}

$(function() {
	$('.tooltip').tooltipster({
		trigger: 'custom',
		triggerOpen: {
			mouseenter: true
		},
		triggerClose: {
			click: false,
			scroll: true,
			mouseleave: true
		}
	});

	if ( typeof caPluginUpdateCheck === "function" ) {
		caPluginUpdateCheck("libvirt.hotplug.usb.plg");
	}
});
</script>
