Menu="VMs:2"
Title="Hotplug USB"
Cond="$var['fsState'] == 'Started'"
---
<?php
/* Copyright 2016, Burhan Shakil
 * Copyright 2018-2026, Dan Landon
 * Copyright 2026, Naphtaline
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License version 3,
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 */
?>

<link rel="stylesheet" href="<?autov("/plugins/libvirt.hotplug.usb/assets/libvirthotplug.css")?>">

<?
/* Define our plugin name. */
define('LIBVIRT_HOTPLUG_PLUGIN', 'libvirt.hotplug.usb');

/* Define the docroot path. */
if (!defined('DOCROOT')) {
	define('DOCROOT', $_SERVER['DOCUMENT_ROOT'] ?: '/usr/local/emhttp');
}

require_once(DOCROOT.'/webGui/include/Helpers.php');
require_once(DOCROOT.'/plugins/dynamix.vm.manager/include/libvirt.php');
require_once(DOCROOT.'/plugins/dynamix.vm.manager/include/libvirt_helpers.php');

/* Return true if the USB device at bus/dev is a hub (i.e., not a leaf device). */
function is_usb_hub_device(int $bus, int $dev): bool
{
	$isHub		= false;
	$sysUsbPath	= '/sys/bus/usb/devices';

	if (is_dir($sysUsbPath)) {
		$entries = glob($sysUsbPath.'/*', GLOB_NOSORT);
		if (is_array($entries)) {
			foreach ($entries as $entry) {
				$busnumFile = $entry.'/busnum';
				$devnumFile = $entry.'/devnum';

				if (!is_file($busnumFile) || !is_file($devnumFile)) {
					continue;
				}

				$busnum = (int)trim((string)@file_get_contents($busnumFile));
				$devnum = (int)trim((string)@file_get_contents($devnumFile));

				if ($busnum !== $bus || $devnum !== $dev) {
					continue;
				}

				$classFile = $entry.'/bDeviceClass';
				if (is_file($classFile)) {
					$classHex = strtolower(trim((string)@file_get_contents($classFile)));
					$isHub = ($classHex === '09');
				}

				break;
			}
		}
	}

	return $isHub;
}

/* This function replaces getValidUSBDevices() from archived repo dynamix.vm.manager. */
function get_complete_usb_devices_infos(): array
{
	$devices		= [];
	$lines			= [];
	$parsed			= [];
	$nameCounts		= [];
	$emittedSingleName	= [];

	exec('lsusb 2>/dev/null', $lines);

	$flashGuid = (string)($GLOBALS['var']['flashGUID'] ?? '');

	/* First pass: parse and filter. */
	foreach ($lines as $line) {
		if (!preg_match('/Bus (?P<bus>\d{3}) Device (?P<device>\d{3}): ID (?P<vid>[0-9a-fA-F]{4}):(?P<pid>[0-9a-fA-F]{4}) (?P<name>.*)$/', $line, $m)) {
			continue;
		}

		$bus	= (int)$m['bus'];
		$dev	= (int)$m['device'];
		$vid	= strtolower($m['vid']);
		$pid	= strtolower($m['pid']);
		$id		= $vid.':'.$pid;
		$name	= trim((string)$m['name']);

		/* Skip Unraid boot device. */
		if ($flashGuid !== '' && stripos($flashGuid, $vid.'-'.$pid) === 0) {
			continue;
		}

		/* Skip Linux root hubs. */
		if ($vid === '1d6b' && in_array($pid, ['0001', '0002', '0003'], true)) {
			continue;
		}

		/* Leaf-only: skip USB hubs (recommended for VM hot-plug). */
		if (is_usb_hub_device($bus, $dev)) {
			continue;
		}

		$parsed[] = [
			'bus'	=> $bus,
			'device'=> $dev,
			'id_1'	=> $vid,
			'id_2'	=> $pid,
			'id'	=> $id,
			'name'	=> $name,
		];

		/* Count duplicates by "same name" (case-insensitive, trimmed). */
		$key = strtolower($name);
		if ($key === '') {
			/* Treat unnamed devices as unique per Bus/Device to avoid collapsing. */
			$key = '__unnamed__|'.$id.'|'.$bus.'|'.$dev;
		}
		$nameCounts[$key] = ($nameCounts[$key] ?? 0) + 1;
	}

	/* Emit:
	 * - If the same name shows up more than once: show all and append Bus/Device.
	 * - Otherwise: show only one entry for that name (suppress duplicates) and omit Bus/Device.
	 */
	foreach ($parsed as $d) {
		$nameKey	= strtolower(trim($d['name']));
		$isUnnamed	= false;

		if ($nameKey === '') {
			$isUnnamed = true;
			$nameKey = '__unnamed__|'.$d['id'].'|'.$d['bus'].'|'.$d['device'];
		}

		$isDupName = (($nameCounts[$nameKey] ?? 0) > 1);

		if (!$isDupName && !$isUnnamed) {
			if (isset($emittedSingleName[$nameKey])) {
				continue;
			}
			$emittedSingleName[$nameKey] = true;
		}

		$baseName = ($d['name'] === '') ? sprintf('[unnamed device] %s', $d['id']) : $d['name'];

		$displayName = $isDupName
			? sprintf('%s (Bus %03d Device %03d)', $baseName, $d['bus'], $d['device'])
			: $baseName;

		$devices[] = [
			'bus'	=> $d['bus'],
			'device'=> $d['device'],
			'id_1'	=> $d['id_1'],
			'id_2'	=> $d['id_2'],
			'id'	=> $d['id'],
			'name'	=> $displayName,
		];
	}

	return $devices;
}

/* Return a set of attached USB IDs (vid:pid) for a given VM (running). */
function get_vm_attached_usb_ids(string $vmname): array
{
	$attached	= [];
	$xmlLines	= [];
	$xml		= '';

	exec('virsh dumpxml '.escapeshellarg($vmname).' 2>/dev/null', $xmlLines);

	if ($xmlLines) {
		$xml = implode("\n", $xmlLines);

		if (preg_match_all(
			'/<hostdev\b[^>]*\btype=[\'"]usb[\'"][^>]*>.*?<source>.*?<vendor\b[^>]*\bid=[\'"]0x([0-9a-fA-F]{4})[\'"][^>]*\/>.*?<product\b[^>]*\bid=[\'"]0x([0-9a-fA-F]{4})[\'"][^>]*\/>.*?<\/source>.*?<\/hostdev>/s',
			$xml,
			$matches,
			PREG_SET_ORDER
		)) {
			foreach ($matches as $m) {
				$id = strtolower($m[1]).':'.strtolower($m[2]);
				$attached[$id] = true;
			}
		}
	}

	return $attached;
}

/* Get array of usb devices. */
$arrValidUSBDevices = get_complete_usb_devices_infos();

/* Get domain variables for each domain. */
$doms	= $lv->get_domains();
$vmlist	= [];

/* Build list of running VMs. */
for ($i = 0; $i < sizeof($doms); $i++) {
	$name	= $doms[$i];
	$res	= $lv->get_domain_by_name($name);
	$dom	= $lv->domain_get_info($res);
	$state	= $lv->domain_state_translate($dom['state']);

	if ($state == 'running') {
		$vmlist[] = ['name' => $name];
	}
}

/* Sort VM list by name. */
if ($vmlist) {
	usort($vmlist, function($a, $b) {
		return strcasecmp((string)$a['name'], (string)$b['name']);
	});
}

/* Build a VM => attached USB (vid:pid) map for button enable/disable logic. */
$vm_attached_map = [];
foreach ($vmlist as $vm) {
	$vmname						= (string)$vm['name'];
	$vm_attached_map[$vmname]	= get_vm_attached_usb_ids($vmname);
}

function list_usbs(): array
{
	$out = [];
	$devices = $GLOBALS['arrValidUSBDevices'] ?? [];

	if ($devices) {
		foreach ($devices as $arrDev) {
			$out[] = [
				'name'	=> $arrDev['name'],
				'id'	=> $arrDev['id'],
				'bus'	=> $arrDev['bus'],
				'device'=> $arrDev['device']
			];
		}
	} else {
		$out[] = ['name' => 'None available', 'id' => '', 'bus' => '', 'device' => ''];
	}

	usort($out, function($a, $b) {
		return strcasecmp((string)$a['name'], (string)$b['name']);
	});

	return $out;
}
?>

<form markdown="1" method="POST" action="/update.php" target="progressFrame">
<span class="inline-block">
<strong>_(Running VMs)_:</strong>
	<select name="vms" size="1" class="lh-vm-select">
		<?foreach ($vmlist as $vms):?>
			<?=mk_option("", $vms['name'], $vms['name'])?>
		<?endforeach;?>
	</select>
</span>
&nbsp;&nbsp;
<span class="inline-block">
<strong>_(USB Devices)_:</strong>
	<select name="usbs" size="1" class="lh-device-select" id="selectedUSBDevice">
		<?=mk_option("", "", _('Select a USB device'))?>
		<?foreach (list_usbs() as $usb):?>
			<?=mk_option("", $usb['id'], $usb['name'], "data-bus=".$usb['bus']." data-device=".$usb['device'])?>
		<?endforeach;?>
	</select>
</span>

:libvirt_hot_plug:
> Select the VM for the USB device to be attached/detached and the USB device for the selected VM.
:end

<span class="inline-block">
	<button type="button" id="usbAction" class="tooltip" title="_(Select a USB device to continue)_" onclick="operateUSB();" disabled>_(Select USB)_</button>
</span>

<strong>_(Result)_:</strong>

<textarea class="lh-result-textbox" readonly name="Status" rows="7" cols="80"></textarea>

<strong>_(Note)_:</strong>
<p>_(Some USB Devices require detaching and attaching multiple times to be properly detected by VMs)_.</p>
<p>_(If you disconnected the USB device while it was attached to a VM)_, _(you will have to detach it and then re-attach it)_.</p>

<input type="button" value="_(Refresh)_" onclick="refresh()"><button type="button" onclick='done()'>_(Done)_</button>
</form>

<script>
const LVURL = '/plugins/<?=LIBVIRT_HOTPLUG_PLUGIN?>/include/virshcmd.php';
const VM_USB_ATTACHED = <?=json_encode($vm_attached_map, JSON_UNESCAPED_SLASHES)?>;

function setUSBActionButton(label, tooltip, action, enabled)
{
	const $btn = $('#usbAction');

	$btn.html(label)
	    .prop('disabled', !enabled)
	    .data('action', action || null);

	/* Update Tooltipster content (NOT the title attribute) */
	if ($btn.hasClass('tooltipstered')) {
		$btn.tooltipster('content', tooltip || '_(Operation in progress)_...');
	}
}

/*
 * Update the single USB action button based on VM + USB selection.
 */
function updateUSBActionButton()
{
	const vm	= $('select[name=vms]').val();
	const usbid	= $('select[name=usbs]').val();

	/* Default: no USB selected */
	if (!vm || !usbid) {
		setUSBActionButton(
			'_(Select USB)_',
			'_(Select a USB device to continue)_',
			null,
			false
		);
		return;
	}

	const attachedSet = VM_USB_ATTACHED[vm] || {};
	const isAttached = !!attachedSet[usbid];

	if (isAttached) {
		setUSBActionButton(
			'<i class="fa fa-unlink"></i>&nbsp;_(Detach USB)_',
			'_(Detach this USB device from the selected VM)_',
			'detach',
			true
		);
	} else {
		setUSBActionButton(
			'<i class="fa fa-plug"></i>&nbsp;_(Attach USB)_',
			'_(Attach this USB device to the selected VM)_',
			'attach',
			true
		);
	}
}

/*
 * Execute attach or detach based on button state.
 */
function operateUSB()
{
	const action = $('#usbAction').data('action');
	if (!action) {
		return;
	}

	const vmSel	= $('select[name=vms]');
	const usbSel = $('select[name=usbs] option:selected');

	const vm = vmSel.val();
	const usbid	= usbSel.val();

	if (!vm || !usbid) {
		return;
	}

	setUSBActionButton(
		action === 'attach'
			? "<i class='fa fa-spinner fa-spin'></i> _(Attaching)_"
			: "<i class='fa fa-spinner fa-spin'></i> _(Detaching)_",
		'',
		null,
		false
	);

	switch (action) {
		case 'detach':
			status = "_(Detaching Please wait)_...";
			break;

		case 'attach':
			status = "_(Attaching Please wait)_...";
			break;
	}
	$("textarea[name=Status]").val(status);

	const opts = {
		action:		action,
		VMNAME:		vm,
		USBID:		usbid,
		USBBUS:		usbSel.attr('data-bus'),
		USBDEVICE:	usbSel.attr('data-device')
	};

	$.post(LVURL, opts).done(function (data) {
		let rc = 1;
		let output = '';

		if (typeof data === 'object' && data !== null) {
			rc = parseInt(data.rc, 10);
			output = String(data.output || '');
		} else {
			/* Backward compatibility if something returns plain text. */
			output = String(data || '');
			rc = (/^\s*error:/mi.test(output)) ? 1 : 0;
		}

		if (output) {
			$('textarea[name=Status]').val(output);
		}
 
 		if (!VM_USB_ATTACHED[vm]) {
 			VM_USB_ATTACHED[vm] = {};
 		}
 
		/* Only update local state on success. */
		if (rc === 0) {
			if (action === 'attach') {
				VM_USB_ATTACHED[vm][usbid] = true;
			} else {
				delete VM_USB_ATTACHED[vm][usbid];
			}
 		}
 
 		updateUSBActionButton();
 	});
}

$(function () {
	$('.tooltip').tooltipster({
		trigger: 'custom',
		triggerOpen: { mouseenter: true },
		triggerClose: { click: false, scroll: true, mouseleave: true }
	});

	if (typeof caPluginUpdateCheck === 'function') {
		caPluginUpdateCheck('libvirt.hotplug.usb.plg');
	}

	$('select[name=vms]').on('change', updateUSBActionButton);
	$('select[name=usbs]').on('change', updateUSBActionButton);

	updateUSBActionButton();
});
</script>
